<!DOCTYPE html>
<html>
	<head>
		<title>Eggdrop Tcl Archive</title>
	</head>
	<style>
		.filtered {
			display: none;
		}
	</style>
	<script type="module">
		let scripts = [];
		let orderby = {
			"name": "id",
			"order": false
		};
		function init() {
			document.getElementById("search").addEventListener("change", filterRows);
			
			// ["name", "version", "date", "author", "description"]
			makeSort("name", false);
			makeSort("version", true);
			makeSort("date", true, parseDate);
			makeSort("author", false);
			makeSort("description", false);
			makeSort("id", false);
			makeSort("downloads", true);
		
			let req = new XMLHttpRequest();
			req.addEventListener("load", loadData);
			req.open("GET", "index.json");
			req.send();
		}
		
		function loadData() {
			scripts = JSON.parse(this.responseText);
			buildTable();
		}
		
		function buildTable() {
			let tbody = document.getElementById("tbody");
			
			for (let scr of scripts) {
				let tr = makeRow(scr);
				scr.tr = tr;
				tbody.appendChild(tr);
			}
		}
		
		function makeRow(scr) {
			let tr = document.createElement("tr");
			let td = document.createElement("td");
			let a = document.createElement("a");
			let url = scr.id + "/" + scr.filename; 
			a.href = url;
			let span = document.createElement("span");
			span.title = scr.downloads + " downloads";
			let text = document.createTextNode(scr.name);
			span.appendChild(text);
			a.appendChild(span);
			td.appendChild(a);
			tr.appendChild(td);
						
			td = document.createElement("td");
			a = document.createElement("a");
			a.href = url;
			a.tabindex = -1;
			span = document.createElement("span");
			text = document.createTextNode(scr.version);
			span.appendChild(text);
			a.appendChild(span);
			td.appendChild(a);
			tr.appendChild(td);
			
			td = document.createElement("td");
			a = document.createElement("a");
			a.href = url;
			a.tabindex = -1;
			span = document.createElement("span");
			text = document.createTextNode(scr.date);
			span.appendChild(text);
			a.appendChild(span);
			td.appendChild(a);
			tr.appendChild(td);
			
			td = document.createElement("td");
			a = document.createElement("a");
			a.href = url;
			a.tabindex = -1;
			span = document.createElement("span");
			text = document.createTextNode(scr.author);
			span.appendChild(text);
			a.appendChild(span);
			td.appendChild(a);
			tr.appendChild(td);
			
			td = document.createElement("td");
			a = document.createElement("a");
			a.href = url;
			a.tabindex = -1;
			span = document.createElement("span");
			text = document.createTextNode(scr.description);
			span.appendChild(text);
			a.appendChild(span);
			td.appendChild(a);
			if (scr.extdesc !== undefined) {
				a = document.createElement("a");			
				a.href = "javascript:";
				a.addEventListener("click", showExt(scr.extdesc));
				text = document.createTextNode("See extended description.");
				a.appendChild(text);
				td.appendChild(a);
			}
			tr.appendChild(td);
			
			return tr;
		}
		
		function showExt(message) {
			return (function() {
				window.alert(message);
			});
		}
		
		function filterRows() {
			let fs = this.value;
			
			let attrs = ["name", "author", "description"];
			
			for (let scr of scripts) {
				let found = false;
				for (let attr of attrs) {
					if (scr[attr].indexOf(fs) != -1) {
						found = true;
						break;
					}
				}
				if (found) {
					scr.tr.classList.remove("filtered");
				} else {
					scr.tr.classList.add("filtered");
				}
			}
		}
		
		function parseDate(d) {
			let re = /(\d\d)\/(\d\d)\/(\d{4})/
			let arr = re.exec(d);
			return new Date(`${arr[3]}-${arr[2]}-${arr[1]}T00:00:00.000Z`);
		}
		
		function makeSort(name, defdesc, fn) {
			if (fn === undefined) {
				fn = a => a;
			};
			let cfa = function(a, b) {
				let av = fn(a[name]);
				let bv = fn(b[name]);
				if (av < bv) {
					return -1;
				} else if (av > bv) {
					return 1;
				} else {
					return 0;
				}
			};
			let cfd = function(a, b) {
				let av = fn(a[name]);
				let bv = fn(b[name]);
				if (av > bv) {
					return -1;
				} else if (av < bv) {
					return 1;
				} else {
					return 0;
				}
			};
			let cb = function() {
				if (orderby.name == name) {
					orderby.order = !orderby.order;
				} else {
					orderby.name = name;
					orderby.order = defdesc;
				}
				scripts.sort(orderby.order ? cfd : cfa);
				let tbody = document.getElementById("tbody");
				for (let scr of scripts) {
					tbody.appendChild(scr.tr);
				}
			};
			document.getElementById("th-" + name).addEventListener("click", cb);
		}
		
		init();
	</script>
	<body>
		<p>This is a read-only mirror of the <a href="https://tclarchive.org/">tclarchive.org</a> scripts.</p>
		<p>Note, the download count is not being updated anymore</p>
		
		<input type="text" id="search" placeholder="search" />
		<p>Sort by: <a href="javascript:" id="th-id">ID</a> <a href="javascript:" id="th-downloads">Downloads</a></p>
		
		<table>
			<thead>
				<tr>
					<th scope="col" id="th-name">Script Name</th>
					<th scope="col" id="th-version">Version</th>
					<th scope="col" id="th-date">Date</th>
					<th scope="col" id="th-author">Author</th>
					<th scope="col" id="th-description">Description</th>
				</tr>
			</thead>
			<tbody id="tbody">
			</tbody>
		</table>
		
	</body>
</html>